// CS3 StorageProvider API
// Copyright (C) 2018  CERN IT-ST
//
// This program is free software: you can redistribute it and/or modify
// it under the terms of the GNU Affero General Public License as
// published by the Free Software Foundation, either version 3 of the
// License, or (at your option) any later version.
//
// This program is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU Affero General Public License for more details.
//
// You should have received a copy of the GNU Affero General Public License
// along with this program.  If not, see <https://www.gnu.org/licenses/>.

syntax = "proto3";

package cs3.storageproviderv0alpha;

option csharp_namespace = "CS3.StorageProviderV0Alpha";
option go_package = "storageproviderv0alphapb";
option java_multiple_files = true;
option java_outer_classname = "StorageproviderProto";
option java_package = "com.cs3.storageproviderv0alpha";
option objc_class_prefix = "CBOXAB";
option php_namespace = "CS3\\StorageProviderV0Alpha";

import "cs3/rpc/status.proto";
import "cs3/storageprovider/v0alpha/resources.proto";
import "cs3/types/types.proto";

// Storage Provider API
// 
// The Storage Provider API is meant to manipulate storage
// resources in the underlying storage system behind the service.
// 
// The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL
// NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED",  "MAY", and
// "OPTIONAL" in this document are to be interpreted as described in
// RFC 2119.
// 
// The following are global requirements that apply to all methods:
// Any method MUST return CODE_OK on a succesful operation.
// Any method MAY return NOT_IMPLEMENTED.
// Any method MAY return INTERNAL.
// Any method MAY return UNKNOWN.
// Any method MAY return UNAUTHENTICATED.
service StorageProviderService {
  // Adds a new grant for the provided reference.
  // MUST return CODE_NOT_FOUND if the reference does not exist
  rpc AddGrant(AddGrantRequest) returns (AddGrantResponse);
  // Creates a new resource of type container.
  // MUST return CODE_PRECONDITION_FAILED if the container
  // cannot be created at the specified reference.
  rpc CreateContainer(CreateContainerRequest) returns (CreateContainerResponse);
  // Deletes a resource. 
  // If a resource specifies the non-empty container (directory, ...),
  // then the entire directory is deleted recursively.
  // If a resource specifies a reference or symlink type, only the reference is removed (not the target).
  // MUST return CODE_NOT_FOUND if the reference does not exist.
  rpc Delete(DeleteRequest) returns (DeleteResponse);
  // Returns the information for this provider.
  rpc GetProvider(GetProviderRequest) returns (GetProviderResponse);
  // Returns the path reference for 
  // the provided resource id reference.
  // MUST return CODE_NOT_FOUND if the reference does not exist
  rpc GetPath(GetPathRequest) returns (GetPathResponse);
  // Returns the quota available under the provided
  // reference.
  // MUST return CODE_NOT_FOUND if the reference does not exist
  // MUST return CODE_RESOURCE_EXHAUSTED on exceeded quota limits.
  rpc GetQuota(GetQuotaRequest) returns (GetQuotaResponse);
  // Initiates the download of a file using an
  // out-of-band data transfer mechanism.
  rpc InitiateFileDownload(InitiateFileDownloadRequest) returns (InitiateFileDownloadResponse);
  // Initiates the upload of a file using an 
  // out-of-band data transfer mechanism.
  rpc InitiateFileUpload(InitiateFileUploadRequest) returns (InitiateFileUploadResponse);
  // Returns the list of grants for the provided reference.
  // MUST return CODE_NOT_FOUND if the reference does not exists.
  rpc ListGrants(ListGrantsRequest) returns (ListGrantsResponse);
  // Returns a stream of resource informations
  // for the provided reference.
  // MUST return CODE_NOT_FOUND if the reference does not exists.
  rpc ListContainerStream(ListContainerStreamRequest) returns (stream ListContainerStreamResponse);
  // Returns a list of resource information
  // for the provided reference.
  // MUST return CODE_NOT_FOUND if the reference does not exists.
  rpc ListContainer(ListContainerRequest) returns (ListContainerResponse);
  // Returns a list of resource information
  // for the provided search query.
  rpc SearchContainer(SearchContainerRequest) returns (SearchContainerResponse);
  // Returns a list of the versions for a resource of 
  // type file at the provided reference.
  // MUST return CODE_NOT_FOUND if the reference does not exist.
  // MUST return CODE_OK and MUST return an empty list if no versions are available.
  rpc ListFileVersions(ListFileVersionsRequest) returns (ListFileVersionsResponse);
  // Returns a stream of recycle items for this storage provider.
  rpc ListRecycleStream(ListRecycleStreamRequest) returns (stream ListRecycleStreamResponse);
  // Returns a list of recycle items for this storage provider.
  // MUST return CODE_OK and MUST return an empty list if no recycle items are available.
  rpc ListRecycle(ListRecycleRequest) returns (ListRecycleResponse);
  // Moves a resource from one reference to another.
  // MUST return CODE_NOT_FOUND if any of the references do not exist.
  // MUST return CODE_PRECONDITION_FAILED if the source reference
  // cannot be moved to the destination reference.
  rpc Move(MoveRequest) returns (MoveResponse);
  // Removes a grant for the provided reference.
  // This is recursive and atomic for directories. Does not follow references.
  // MUST return CODE_NOT_FOUND if the reference does not exist.
  // MUST return CODE_NOT_FOUND if grant does not exist.
  rpc RemoveGrant(RemoveGrantRequest) returns (RemoveGrantResponse);
  // Permanently removes a recycle item from the recycle.
  // This operation is irrevocable.
  // MUST return CODE_NOT_FOUND if the recycle item id does not exist.
  rpc PurgeRecycle(PurgeRecycleRequest) returns (PurgeRecycleResponse);
  // Restores a file version for the provided reference. 
  // MUST return CODE_NOT_FOUND if the reference does not exist.
  // MUST return CODE_NOT_FOUND if the version does not exist.
  rpc RestoreFileVersion(RestoreFileVersionRequest) returns (RestoreFileVersionResponse);
  // Restores a recycle item from the recycle.
  // MUST return CODE_NOT_FOUND if the recycle item id does not exist.
  // MUST return CODE_PRECONDITION_FAILED if the restore_path is non-empty 
  // and the recycle item cannot be restored to the restore_path.
  rpc RestoreRecycleItem(RestoreRecycleItemRequest) returns (RestoreRecycleItemResponse);
  // Returns the resource information at the provided reference.
  // MUST return CODE_NOT_FOUND if the reference does not exist.
  rpc Stat(StatRequest) returns (StatResponse);
  // Updates an ACL for the provided reference.
  // MUST return CODE_NOT_FOUND if the reference does not exist.
  // MUST return CODE_PRECONDITION_FAILED if the acl does not exist.
  rpc UpdateGrant(UpdateGrantRequest) returns (UpdateGrantResponse);
}

message AddGrantRequest {
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 1;
  // REQUIRED.
  // The reference to which the action should be performed.
  Reference ref = 2;
  // REQUIRED.
  // The grant to be added.
  Grant grant = 3;
}

message AddGrantResponse {
  // REQUIRED.
  // The response status.
  cs3.rpc.Status status = 1;
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 2;
}

message CreateContainerRequest {
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 1;
  // REQUIRED.
  // The reference to which the action should be performed.
  Reference ref = 2;
}

message CreateContainerResponse {
  // REQUIRED.
  // The response status.
  cs3.rpc.Status status = 1;
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 2;
}

message DeleteRequest {
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 1;
  // REQUIRED.
  // The reference to which the action should be performed.
  Reference ref = 2;
}

message DeleteResponse {
  // REQUIRED.
  // The response status.
  cs3.rpc.Status status = 1;
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 2;
}

message GetProviderRequest {
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 1;
}

message GetProviderResponse {
  // REQUIRED.
  // The response status.
  cs3.rpc.Status status = 1;
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 2;
  // REQUIRED.
  // The information for the storage provider.
  ProviderInfo info = 3;
}

message GetPathRequest {
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 1;
  // REQUIRED.
  // The resource id of the resource.
  ResourceId resource_id = 2;
}

message GetPathResponse {
  // REQUIRED.
  // The response status.
  cs3.rpc.Status status = 1;
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 2;
}

message GetQuotaRequest {
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 1;
}

message GetQuotaResponse {
  // REQUIRED.
  // The response status.
  cs3.rpc.Status status = 1;
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 2;
  // REQUIRED.
  // The total available bytes.
  uint64 total_bytes = 3;
  // REQUIRED.
  // The number of used bytes.
  uint64 used_bytes = 4;
}

message InitiateFileUploadRequest {
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 1;
  // REQUIRED.
  // The reference to which the action should be performed.
  Reference ref = 2;
}

message InitiateFileUploadResponse {
  // REQUIRED.
  // The response status.
  cs3.rpc.Status status = 1;
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 2;
  // REQUIRED.
  // The endpoint where to upload the data.
  // The value MUST be a Uniform Resource Identifier (URI)
  // as specified in RFC 3986.
  string upload_endpoint = 3;
}

message InitiateFileDownloadRequest {
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 1;
  // REQUIRED.
  // The reference to which the action should be performed.
  Reference ref = 2;
}

message InitiateFileDownloadResponse {
  // REQUIRED.
  // The response status.
  cs3.rpc.Status status = 1;
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 2;
  // REQUIRED.
  // The endpoint where to downooad the data.
  // The value MUST be a Uniform Resource Identifier (URI)
  // as specified in RFC 3986.
  string download_endpoint = 3;
}

message ListGrantsRequest {
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 1;
  // REQUIRED.
  // The reference to which the action should be performed.
  Reference ref = 2;
}

message ListGrantsResponse {
  // REQUIRED.
  // The response status.
  cs3.rpc.Status status = 1;
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 2;
  // REQUIRED.
  // The grants.
  repeated Grant grants = 3;
}

message ListContainerStreamRequest {
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 1;
  // REQUIRED.
  // The reference to which the action should be performed.
  Reference ref = 2;
}

message ListContainerStreamResponse {
  // REQUIRED.
  // The response status.
  cs3.rpc.Status status = 1;
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 2;
  // REQUIRED.
  // The resource information.
  ResourceInfo info = 3;
}

message ListContainerRequest {
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 1;
  // REQUIRED.
  // The reference to which the action should be performed.
  Reference ref = 2;
}

message ListContainerResponse {
  // REQUIRED.
  // The response status.
  cs3.rpc.Status status = 1;
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 2;
  // REQUIRED.
  // The list of resource informations.
  repeated ResourceInfo infos = 3;
}

message SearchContainerRequest {
  // based on encrypted cursor based bidirectional paging
  // with added offset for fast scrolling to the middle of the list
  // see https://hackernoon.com/guys-were-doing-pagination-wrong-f6c18a91b232
  int32 limit = 1;
  // pages either start
  oneof page {
    // from a before or after token of a preceeding response
    // it contains the current sort column, direction and the last value of the previous page
    string token = 2
    // at an offset to allow direct jumping
    int32 offset = 3
  }
  // a lucene search query, for a good read see https://www.javacodegeeks.com/2015/09/advanced-lucene-query-examples.html
  string query = 4;
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 5;
}

message SearchContainerResponse {
  // REQUIRED.
  // The response status.
  cs3.rpc.Status status = 1;
  // OPTIONAL.
  // a before and after token for the next request
  // it contains the current sort column, direction and the last value of the page
  string before = 2;
  string after = 3;
  // OPTIONAL.
  // total number of results for page stats
  int32 total = 4;
  // OPTIONAL.
  // current offset
  int32 offset = 5;  
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 6;
  // REQUIRED.
  // The list of resource informations.
  repeated ResourceInfo infos = 7;
}

message ListFileVersionsRequest {
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 1;
  // REQUIRED.
  // The reference to which the action should be performed.
  Reference ref = 2;
}

message ListFileVersionsResponse {
  // REQUIRED.
  // The response status.
  cs3.rpc.Status status = 1;
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 2;
  // REQUIRED.
  // The list of file versions.
  repeated FileVersion versions = 3;
}

message ListRecycleRequest {
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 1;
  // OPTIONAL.
  // SHOULD be specified.
  // The start time range to query for recycle items.
  // The value is the Unix Epoch timestamp in seconds.
  cs3.types.Timestamp from_ts = 2;
  // OPTIONAL.
  // SHOULD be specified.
  // The end time range to query for recycle items.
  // The value is Unix Epoch timestamp in seconds.
  cs3.types.Timestamp to_ts = 3;
}

message ListRecycleResponse {
  // REQUIRED.
  // The response status.
  cs3.rpc.Status status = 1;
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 2;
  // REQUIRED.
  // The list of recycle items.
  repeated RecycleItem recycle_items = 3;
}

message ListRecycleStreamRequest {
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 1;
  // OPTIONAL.
  // SHOULD be specified.
  // The start time range to query for recycle items.
  // The value is the Unix Epoch timestamp in seconds.
  cs3.types.Timestamp from_ts = 2;
  // OPTIONAL.
  // SHOULD be specified.
  // The end time range to query for recycle items.
  // The value is Unix Epoch timestamp in seconds.
  cs3.types.Timestamp to_ts = 3;
}

message ListRecycleStreamResponse {
  // REQUIRED.
  // The response status.
  cs3.rpc.Status status = 1;
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 2;
  // REQUIRED.
  // The recycle items.
  RecycleItem recycle_item = 3;
}

message MoveRequest {
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 1;
  // REQUIRED.
  // The source reference the resource is moved from.
  Reference source = 2;
  // REQUIRED.
  // The destination reference the resource is moved to.
  Reference destination = 3;
}

message MoveResponse {
  // REQUIRED.
  // The response status.
  cs3.rpc.Status status = 1;
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 2;
}

message PurgeRecycleRequest {
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 1;
  // REQUIRED.
  // The reference to which the action should be performed.
  Reference ref = 2;
}

message PurgeRecycleResponse {
  // REQUIRED.
  // The response status.
  cs3.rpc.Status status = 1;
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 2;
}

message RestoreFileVersionRequest {
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 1;
  // REQUIRED.
  // The reference to which the action should be performed.
  Reference ref = 2;
  // REQUIRED.
  // The key to restore a specific file version. 
  string key = 3;
}

message RestoreFileVersionResponse {
  // REQUIRED.
  // The response status.
  cs3.rpc.Status status = 1;
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 2;
}

// TODO: restore to original location if not specified as OPTIONAL?
message RestoreRecycleItemRequest {
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 1;
  // REQUIRED.
  // The reference to which the action should be performed.
  Reference ref = 2;
  // REQUIRED.
  // The key for the recycle item to be restored.
  string key = 3;
  // OPTIONAL.
  // An optional restore path for the deleted resource.
  // It can be useful to restore to another location rather than
  // the original.
  // If empty, service implementors MUST restore 
  // to original location if possible. 
  string restore_path = 4;
}

message RestoreRecycleItemResponse {
  // REQUIRED.
  // The response status.
  cs3.rpc.Status status = 1;
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 2;
}

message RemoveGrantRequest {
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 1;
  // REQUIRED.
  // The reference to which the action should be performed.
  Reference ref = 2;
  // REQUIRED.
  // The grant to remove.
  Grant grant = 3;
}

message RemoveGrantResponse {
  // REQUIRED.
  // The response status.
  cs3.rpc.Status status = 1;
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 2;
}

message StatRequest {
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 1;
  // REQUIRED.
  // The reference to which the action should be performed.
  Reference ref = 2;
}

message StatResponse {
  // REQUIRED.
  // The response status.
  cs3.rpc.Status status = 1;
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 2;
  // REQUIRED.
  // The resource information.
  ResourceInfo info = 3;
}

message UpdateGrantRequest {
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 1;
  // REQUIRED.
  // The reference to which the action should be performed.
  Reference ref = 2;
  // REQUIRED.
  // The grant to be updated.
  Grant grant = 3;
}

message UpdateGrantResponse {
  // REQUIRED.
  // The response status.
  cs3.rpc.Status status = 1;
  // OPTIONAL.
  // Opaque information.
  cs3.types.Opaque opaque = 2;
}
